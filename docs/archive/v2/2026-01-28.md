## Session Summary

### What We Built Today

**1. ConversationPanel with "Stick to Bottom" Scroll Behavior**
- Tracks `_wasAtBottom` BEFORE new items are added (avoids race condition)
- Listens to `ChatState` changes via `addListener` for real-time updates
- Auto-scrolls only when user was already at bottom

**2. MessageInput Widget**
- Multi-line input with Enter to submit, Shift+Enter for newline
- Auto-focus on mount and app resume

**3. Global Keyboard Focus Management** (the "hack" that works)
- `KeyboardFocusManager` uses `HardwareKeyboard.instance.addHandler()` to intercept ALL keyboard events globally
- When a typing key is pressed and message input doesn't have focus:
  - Focuses the message input
  - Manually inserts the character into the controller
  - Returns `true` to consume the event
- Handles backspace/delete by modifying the controller directly
- Excludes: keyboard shortcuts (Cmd+X), arrow keys, function keys, Tab, Enter, Escape
- **Key insight**: You can't just focus and hope the event propagates - by the time focus changes, the event is gone. Must manually insert.

**4. Integration & Widget Tests**
- Integration tests in `integration_test/app_test.dart` (16 tests, require device)
- Widget tests in `test/widget/keyboard_focus_manager_test.dart` (5 tests, CI-friendly)
- All 168 tests pass

### Key Files Changed/Created
- `lib/widgets/keyboard_focus_manager.dart` - Global keyboard handler
- `lib/widgets/message_input.dart` - Simplified, registers with manager
- `lib/widgets/conversation_panel.dart` - Scroll behavior + ChatState listening
- `lib/widgets/output_entries.dart` - Entry display widgets
- `lib/main.dart` - Wrapped with `KeyboardFocusManager`
- `test/widget/keyboard_focus_manager_test.dart` - New widget tests

### Previous Session: drag_split_layout Fork
- Forked to add `onBeforeReplace` callback for intercepting panel merges
- Enables merge behavior (agents → chats, chats → worktrees) instead of replace
- Local dependency in `pubspec.yaml` pointing to forked repo

---

## Tomorrow's Plan: Git Service Testing

**The Problem**: `pump()` advances test clock but not wall-clock time. Real git operations timeout in tests.

**Proposed Architecture**:
```
GitService (abstract)
├── RealGitService - spawns actual git processes
└── FakeGitService - returns canned responses instantly
```

**Test Layers**:
1. **Unit tests**: Test git output parsing (pure functions, no I/O)
2. **Widget tests**: Inject `FakeGitService`, test UI behavior
3. **Integration tests**: Use `tester.runAsync()` for real git operations

---

## Regarding drag_split_layout PR

Good instinct to consider upstreaming. A few thoughts:

**Worth PRing:**
- `onBeforeReplace` callback is a clean, non-breaking addition
- General-purpose (others might want merge/intercept behavior)
- Small, focused change

**Before PRing:**
- Check if the maintainer is active (look at recent commits/issues)
- Clean up the implementation if needed
- Write a clear description of the use case
- Consider if there are other intercept points that would be useful (make it more general?)

**Alternative**: If maintainer is inactive, you could publish your fork as a separate package or just keep it local. The local fork works fine for your needs.

I'd suggest opening an issue first to gauge interest before spending time on a PR.
